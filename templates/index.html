<!DOCTYPE html>
<html lang="fr" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DX Neural AI v1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* --- STYLE GLOBAL --- */
        body { background-color: #212529; color: #f8f9fa; }
        
        /* TICKER */
        .ticker-wrap { width: 100%; background-color: #111; overflow: hidden; height: 35px; line-height: 35px; }
        .ticker { display: inline-block; white-space: nowrap; padding-left: 100%; animation: ticker 60s linear infinite; }
        .ticker-item { color: #00ffff; font-family: 'Consolas', monospace; font-weight: bold; }
        @keyframes ticker { 100% { transform: translate3d(-100%, 0, 0); } }

        /* HIGHLIGHTS */
        tr.watchlist-hit { background-color: #FFD700 !important; color: #000 !important; font-weight: bold; }
        tr.watchlist-hit a { color: #000 !important; }
        
        /* MAP & UI */
        #map { height: 500px; width: 100%; border-radius: 0 0 8px 8px; }
        .spot-row { font-family: 'Consolas', monospace; font-size: 0.9rem; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        /* AUDIO ANIMATION */
        .audio-active { animation: pulse 2s infinite; color: #ff4444 !important; }
        @keyframes pulse { 50% { text-shadow: 0 0 10px #f00; } }
    </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom border-secondary py-1">
    <div class="container-fluid">
        <a class="navbar-brand d-flex align-items-center fw-bold" href="#">
            <i class="fa-solid fa-microchip me-2 text-info"></i> 
            <div>
                DX WATCHER <span class="text-warning">NEURAL AI</span>
                <div style="font-size: 0.6rem; color: #aaa;">{{ version }}</div>
            </div>
        </a>
        <div class="ms-auto text-white small">
            <i class="fa-regular fa-clock"></i> <span id="utc-clock">00:00 UTC</span> | {{ my_call }}
        </div>
    </div>
</nav>

<!-- TICKER -->
<div class="ticker-wrap"><div class="ticker"><div class="ticker-item" id="rss-content">Initialisation du Neural Engine...</div></div></div>

<div class="container-fluid mt-3">
    <div class="row">
        <!-- GAUCHE -->
        <div class="col-lg-8">
            <!-- Carte -->
            <div class="card mb-3 border-0"><div class="card-body p-0"><div id="map"></div></div></div>
            
            <div class="row">
                <!-- Graphique -->
                <div class="col-md-6">
                    <div class="card mb-3 bg-dark text-light border-secondary">
                        <div class="card-header fw-bold"><i class="fa-solid fa-chart-column"></i> Propagation par Bande</div>
                        <div class="card-body" style="height:250px"><canvas id="bandChart"></canvas></div>
                    </div>
                </div>
                <!-- Ranking IA -->
                <div class="col-md-6">
                    <div class="card mb-3 bg-dark text-light border-secondary">
                        <div class="card-header fw-bold d-flex justify-content-between">
                            <span><i class="fa-solid fa-trophy text-warning"></i> Neural Ranking</span>
                            <span class="badge bg-danger">LIVE AI</span>
                        </div>
                        <ul class="list-group list-group-flush small" id="neural-list" style="overflow-y: auto; height: 250px;"></ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- DROITE -->
        <div class="col-lg-4">
            <!-- Watchlist -->
            <div class="card mb-3 border-warning shadow-sm" style="background: #222;">
                <div class="card-header bg-warning text-dark fw-bold d-flex justify-content-between">
                    <span><i class="fa-solid fa-eye"></i> Watchlist</span>
                    <button class="btn btn-sm btn-dark" id="btn-audio" onclick="toggleAudio()"><i class="fa-solid fa-volume-xmark" id="icon-audio"></i></button>
                </div>
                <div class="card-body p-2">
                    <div class="input-group input-group-sm mb-2">
                        <input type="text" id="watch-input" class="form-control bg-dark text-white" placeholder="Call...">
                        <button class="btn btn-warning" onclick="addWatch()">+</button>
                    </div>
                    <div id="watchlist-badges" class="d-flex flex-wrap gap-1"></div>
                </div>
            </div>

            <!-- Spots Table -->
            <div class="card h-100 bg-dark border-secondary">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span class="text-white fw-bold">Live Spots</span>
                    <span class="badge bg-success" id="spot-count">0</span>
                </div>
                <div class="table-responsive no-scrollbar" style="height: 500px; overflow-y: auto;">
                    <table class="table table-dark table-hover table-sm spot-row mb-0">
                        <thead class="sticky-top bg-secondary">
                            <tr><th>UTC</th><th>Call</th><th>Freq</th><th>Pays</th><th class="text-end">AI</th></tr>
                        </thead>
                        <tbody id="spots-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    // --- AUDIO & CONFIG ---
    let audioEnabled=false, spokenSpots=[], watchlist=JSON.parse(localStorage.getItem('watchlist')||'[]');
    function toggleAudio() {
        audioEnabled=!audioEnabled;
        document.getElementById('icon-audio').className = audioEnabled ? 'fa-solid fa-volume-high' : 'fa-solid fa-volume-xmark';
        document.getElementById('btn-audio').classList.toggle('audio-active');
    }
    function speak(txt) { if(audioEnabled) window.speechSynthesis.speak(new SpeechSynthesisUtterance(txt)); }

    // --- MAP SETUP ---
    const map = L.map('map').setView([20,0], 2);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
    let markers = L.layerGroup().addTo(map);

    // --- CHART SETUP (COULEURS FIXES) ---
    const bandLabels = ["160m","80m","40m","30m","20m","17m","15m","12m","10m","6m","2m","70cm","QO-100"];
    const bandColors = [
        '#5D4037', // 160m Brown
        '#7B1FA2', // 80m Purple
        '#1A237E', // 40m Navy
        '#004D40', // 30m Teal
        '#1976D2', // 20m Blue
        '#0097A7', // 17m Cyan
        '#0288D1', // 15m Light Blue
        '#F57C00', // 12m Orange
        '#FFD600', // 10m Gold
        '#C2185B', // 6m Pink
        '#D32F2F', // 2m Red
        '#388E3C', // 70cm Green
        '#00E676'  // QO-100 Neon
    ];
    let bandChartCtx = document.getElementById('bandChart').getContext('2d');
    let myChart = new Chart(bandChartCtx, {
        type: 'bar',
        data: { 
            labels: bandLabels, 
            datasets: [{ data: Array(13).fill(0), backgroundColor: bandColors, borderWidth: 0 }] 
        },
        options: { 
            responsive:true, maintainAspectRatio:false, 
            plugins:{legend:{display:false}}, 
            scales:{x:{grid:{display:false}}, y:{grid:{color:'#333'}, beginAtZero:true}} 
        }
    });

    // --- WATCHLIST LOGIC ---
    function updateWatchlistUI() {
        const c = document.getElementById('watchlist-badges'); c.innerHTML='';
        watchlist.forEach(w => c.innerHTML+=`<span class="badge bg-warning text-dark cursor-pointer" onclick="removeWatch('${w}')">${w} <i class="fa fa-times"></i></span>`);
    }
    function addWatch() { 
        let v = document.getElementById('watch-input').value.toUpperCase().trim(); 
        if(v && !watchlist.includes(v)) { watchlist.push(v); localStorage.setItem('watchlist', JSON.stringify(watchlist)); updateWatchlistUI(); fetchData(); }
    }
    window.removeWatch = (w) => { watchlist=watchlist.filter(x=>x!==w); localStorage.setItem('watchlist', JSON.stringify(watchlist)); updateWatchlistUI(); fetchData(); };
    updateWatchlistUI();

    // --- MAIN LOOP ---
    async function fetchData() {
        try {
            const [resSpots, resRss, resWanted] = await Promise.all([
                fetch('/spots.json'), fetch('/rss.json'), fetch('/wanted.json')
            ]);
            const spots = await resSpots.json();
            const rss = await resRss.json();
            const ranking = await resWanted.json();

            // 1. Ticker
            if(rss.ticker) document.getElementById('rss-content').innerText = rss.ticker;

            // 2. Ranking IA
            const list = document.getElementById('neural-list'); list.innerHTML = '';
            ranking.forEach((item, i) => {
                let badge = item.score > 80 ? 'bg-danger' : 'bg-warning text-dark';
                list.innerHTML += `
                    <li class="list-group-item bg-transparent text-white d-flex justify-content-between py-1 border-secondary">
                        <span>${i+1}. <strong>${item.call}</strong> <span class="text-muted small">(${item.c})</span></span>
                        <span class="badge ${badge} rounded-pill">${item.score}</span>
                    </li>`;
            });

            // 3. Spots & Map
            const tbody = document.getElementById('spots-body'); 
            tbody.innerHTML=''; markers.clearLayers();
            document.getElementById('spot-count').innerText = spots.length;
            
            let countsMap = {}; // Temp storage for chart counts

            spots.forEach(s => {
                // Compte pour le chart
                countsMap[s.band] = (countsMap[s.band] || 0) + 1;

                // Logique Watchlist / AI
                let isW = s.is_wanted || watchlist.some(w => s.dx_call.includes(w));
                let cls = isW ? 'watchlist-hit' : '';
                let scoreBadge = s.score > 50 ? 'bg-danger' : 'bg-secondary';
                
                // Audio
                if(isW && audioEnabled) {
                    let sid = s.dx_call+s.band+s.time;
                    if(!spokenSpots.includes(sid)) { spokenSpots.push(sid); speak(`Alerte DX ${s.dx_call} sur ${s.band}`); }
                }

                // Tableau
                tbody.insertAdjacentHTML('beforeend', `
                    <tr class="${cls}">
                        <td>${s.time}</td>
                        <td><a href="https://www.qrz.com/db/${s.dx_call}" target="_blank" class="fw-bold text-decoration-none text-reset">${s.dx_call}</a></td>
                        <td>${s.freq}</td>
                        <td class="text-truncate" style="max-width:100px;">${s.country}</td>
                        <td class="text-end"><span class="badge ${scoreBadge}">${s.score}</span></td>
                    </tr>
                `);

                // Map Marker
                if(s.lat !== 0) {
                    let col = isW ? '#FFD700' : (s.score>50?'#ff4444':'#00ff9d');
                    L.circleMarker([s.lat, s.lon], {radius: isW?8:3, color: col, fillColor: col, fillOpacity:0.8}).addTo(markers)
                     .bindPopup(`<div class="text-center">
                                    <strong style="font-size:1.1em">${s.dx_call}</strong><br>
                                    <span class="badge bg-dark border border-secondary">${s.freq} kHz</span><br>
                                    <span class="small text-muted">Score IA: ${s.score}</span>
                                 </div>`);
                }
            });

            // 4. Update Chart Data (Fixed Order)
            let chartData = bandLabels.map(b => countsMap[b] || 0);
            myChart.data.datasets[0].data = chartData;
            myChart.update();

        } catch(e) { console.error("Err:", e); }
    }
    
    setInterval(()=>document.getElementById('utc-clock').innerText=new Date().toISOString().substring(11,16)+' UTC', 1000);
    setInterval(fetchData, 5000);
    fetchData();
</script>
</body>
</html>
