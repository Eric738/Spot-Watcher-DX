<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NEURAL DX v4.1 - Final Design</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script> 
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <style>
        /* Variables de ThÃ¨me par DÃ©faut (SoftTech V4.1 Original) */
        :root {
            --bg-color: #050505;
            --panel-bg: #0e0e0e; 
            --text-main: #a0a0a0;
            --accent: #00f3ff;
            --alert: #ff003c; /* Rouge vif pour Surge */
            --border: 1px solid #333; 
            --wl-bg: #ffeb3b; 
            --wl-text: #000000;
            --open-color: #d35400; 
        }

        /* ThÃ¨me Nuit (DarkMode V4.1 Original) */
        body[data-theme='dark'] {
            --bg-color: #1a1a1a;
            --panel-bg: #2a2a2a;
            --text-main: #f0f0f0;
            --accent: #00ff80; 
            --alert: #ff6347; 
            --border: 1px solid #555;
            --wl-bg: #ffff00;
            --wl-text: #000000;
            --open-color: #ffd700;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Share Tech Mono', monospace;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        #header {
            background-color: var(--panel-bg);
            padding: 10px 20px;
            border-bottom: var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        #title {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.5em;
            color: var(--accent);
            text-shadow: 0 0 5px var(--accent);
        }

        /* Ticker */
        #ticker-container {
            background-color: #0d0d0d;
            color: var(--text-main);
            padding: 5px 0;
            overflow: hidden;
            white-space: nowrap;
            border-bottom: var(--border);
            width: 100%;
        }

        #ticker-content {
            display: inline-block;
            padding-left: 100%; 
            animation: ticker-roll 60s linear infinite; 
        }
        
        @keyframes ticker-roll {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }


        #main-container {
            display: flex;
            padding: 10px;
            gap: 10px;
        }

        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .panel {
            background-color: var(--panel-bg);
            border: var(--border); 
            border-radius: 5px;
            padding: 10px;
            min-height: 150px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
        }

        .panel-header {
            font-family: 'Orbitron', sans-serif;
            font-size: 1.1em;
            color: var(--accent);
            margin-bottom: 8px;
            border-bottom: 1px dotted #333;
            padding-bottom: 5px;
            display: flex;
            align-items: center;
            cursor: grab;
        }
        
        /* Handle de Drag & Drop (le "crochet") */
        .dd-handle {
            font-size: 1.5em;
            cursor: grab;
            margin-right: 5px;
            color: var(--text-main);
            opacity: 0.5;
        }

        .dd-handle:hover {
            opacity: 1;
            color: var(--accent);
        }
        
        /* ALERTE SURGE (clignotant ROUGE) */
        #surge-panel.active-surge {
            border: 3px solid var(--alert); 
            box-shadow: 0 0 15px var(--alert);
            animation: pulse-red 1s infinite alternate;
        }

        @keyframes pulse-red {
            from { box-shadow: 0 0 10px var(--alert); }
            to { box-shadow: 0 0 20px var(--alert), 0 0 5px var(--alert); }
        }


        /* Tableaux */
        .spot-table, .wl-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        
        /* NOUVEAU: Callsign en gras blanc (sauf Watchlist) */
        .spot-call-white-bold {
            color: #ffffff; 
            font-weight: bold;
        }
        
        /* Assurer que le lien QRZ Ã  l'intÃ©rieur est Ã©galement en blanc */
        .spot-call-white-bold a {
            color: inherit !important; 
        }
        
        /* Ã‰tiquettes de bande dans le tableau */
        .band-tag {
            display: inline-block;
            padding: 2px 5px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: bold;
            color: #000;
            text-shadow: none;
        }
        
        /* Liens QRZ */
        .spot-table a {
            color: inherit;
            text-decoration: none;
        }

        .spot-table th, .spot-table td, .wl-table th, .wl-table td {
            padding: 4px;
            text-align: left;
            border-bottom: 1px dotted #1a1a1a;
        }

        .spot-table th {
            color: var(--text-main);
            background-color: #1a1a1a;
            position: sticky;
            top: 0;
        }
        
        .high-spd {
            color: var(--alert); 
            font-weight: bold;
        }
        
        .wl-table td.call {
            color: var(--wl-text); 
            background-color: var(--wl-bg);
            font-weight: bold;
            text-align: center;
        }

        #spots-container-hf, #spots-container-vhf, #watchlist-container {
            max-height: 300px; 
            overflow-y: auto;
            margin-top: 5px;
        }
        
        /* Maps */
        .map-panel {
            min-height: 250px;
        }
        .map-area {
            height: 200px;
            border: 1px solid #555;
            border-radius: 3px;
        }
        
        /* Formulaire QRA */
        #qra-form {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            align-items: center;
        }
        #qra-form input[type="text"] {
            padding: 5px;
            border: 1px solid #555;
            background-color: #333;
            color: var(--text-main);
            width: 80px;
            text-transform: uppercase;
        }
        #qra-form button {
            padding: 5px 10px;
            background-color: var(--accent);
            color: var(--panel-bg);
            border: none;
            cursor: pointer;
        }
        
        .icon-button {
            background: none;
            border: none;
            color: var(--accent);
            font-size: 1.2em;
            cursor: pointer;
            margin-left: 10px;
        }

        #indicators {
            display: flex;
            gap: 15px;
            font-size: 0.9em;
        }

        .indicator-item {
            color: var(--text-main);
        }

        .indicator-item span {
            color: var(--accent);
            font-weight: bold;
        }

        .ranking-list {
            list-style: none;
            padding: 0;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            border-bottom: 1px dotted #222;
        }

        .ranking-call {
            color: var(--accent);
            font-weight: bold;
        }

        .ranking-score {
            color: var(--alert);
        }
        
        #surge-container {
            font-size: 1em;
            padding: 5px;
        }

        .surge-band {
            display: inline-block;
            background-color: var(--alert); 
            color: #ffffff;
            padding: 2px 6px;
            margin: 3px;
            border-radius: 3px;
            font-family: 'Orbitron', sans-serif;
            font-weight: bold;
        }
        
        .filter-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 5px;
        }
        .filter-controls select {
            padding: 5px;
            background-color: #333;
            color: var(--text-main);
            border: 1px solid #555;
        }

    </style>
</head>
<body>

    <div id="header">
        <div id="title">NEURAL DX WATCHER V4.1</div>
        <div id="controls">
            <span id="indicators">
                <div class="indicator-item">QRA: <span id="qra-display">{{ user_qra }}</span></div>
                <div class="indicator-item">UTC: <span id="utc-time"></span></div>
                <div class="indicator-item">LOC: <span id="local-time"></span></div>
                <div class="indicator-item">MODE: <span id="display-mode">SoftTech</span></div>
            </span>
            <button class="icon-button" onclick="toggleTheme()" title="Changer de thÃ¨me">ðŸ”†</button>
        </div>
    </div>
    
    <div id="ticker-container">
        <div id="ticker-content">SYSTEM INITIALIZATION...</div>
    </div>

    <div id="main-container">
        <div class="column" id="col1">

            <div id="watchlist-panel" class="panel" data-panel-id="watchlist">
                <div class="panel-header"><span class="dd-handle" title="Drag & Drop">â‹®â‹®</span> WATCHLIST</div>
                
                <form id="add-wl-form" style="display: flex; gap: 5px; margin-bottom: 10px;">
                    <input type="text" id="wl_callsign" placeholder="Callsign Ã  ajouter" style="flex-grow: 1; padding: 5px; border: 1px solid #555; background-color: #333; color: var(--text-main); text-transform: uppercase;" required>
                    <button type="submit" style="padding: 5px 10px; background-color: var(--accent); color: var(--panel-bg); border: none; cursor: pointer;">Add</button>
                </form>
                
                <div id="watchlist-container">
                    <table class="wl-table">
                        <thead>
                            <tr>
                                <th>Call</th>
                                <th>Band</th>
                                <th>Mode</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="watchlist-body">
                            <tr><td colspan="4" style="text-align: center;">Loading Watchlist...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="spots-hf-panel" class="panel" data-panel-id="spots-hf">
                <div class="panel-header"><span class="dd-handle" title="Drag & Drop">â‹®â‹®</span> DX SPOTS HF</div>
                <div class="filter-controls">
                    <select id="hf-band-filter">
                        <option value="All">All Bands</option>
                        </select>
                    <select id="hf-mode-filter">
                        <option value="All">All Modes</option>
                        <option value="FT8">FT8</option>
                        <option value="CW">CW</option>
                        <option value="SSB">SSB</option>
                        <option value="FT4">FT4</option>
                    </select>
                </div>
                <div id="spots-container-hf">
                    <table class="spot-table">
                        <thead>
                            <tr>
                                <th>Time</th><th>Freq</th><th>Call</th><th>Band</th><th>Mode</th><th title="Score de PrioritÃ© DX">SPD</th><th>Dist (km)</th>
                            </tr>
                        </thead>
                        <tbody id="spots-body-hf">
                            <tr><td colspan="7" style="text-align: center;">Waiting for spots...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="spots-vhf-panel" class="panel" data-panel-id="spots-vhf">
                <div class="panel-header"><span class="dd-handle" title="Drag & Drop">â‹®â‹®</span> DX SPOTS VHF/UHF</div>
                <div class="filter-controls">
                    <select id="vhf-band-filter">
                        <option value="All">All Bands</option>
                        </select>
                    <select id="vhf-mode-filter">
                        <option value="All">All Modes</option>
                        <option value="FT8">FT8</option>
                        <option value="MSK144">MSK144</option>
                        <option value="CW">CW</option>
                        <option value="SSB">SSB</option>
                        <option value="FM">FM</option>
                    </select>
                </div>
                <div id="spots-container-vhf">
                    <table class="spot-table">
                        <thead>
                            <tr>
                                <th>Time</th><th>Freq</th><th>Call</th><th>Band</th><th>Mode</th><th title="Score de PrioritÃ© DX">SPD</th><th>Dist (km)</th>
                            </tr>
                        </thead>
                        <tbody id="spots-body-vhf">
                            <tr><td colspan="7" style="text-align: center;">Waiting for spots...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            
            <div id="wanted-panel" class="panel" data-panel-id="wanted">
                <div class="panel-header"><span class="dd-handle" title="Drag & Drop">â‹®â‹®</span> DX WANTED (TOP 10)</div>
                <div style="display: flex; gap: 20px;">
                    <div style="flex: 1;">
                        <h4 style="color: var(--accent);">HF</h4>
                        <ul id="ranking-hf" class="ranking-list"><li>Loading...</li></ul>
                    </div>
                    <div style="flex: 1;">
                        <h4 style="color: var(--accent);">VHF/UHF</h4>
                        <ul id="ranking-vhf" class="ranking-list"><li>Loading...</li></ul>
                    </div>
                </div>
            </div>

        </div>

        <div class="column" id="col2">

            <div id="surge-panel" class="panel" data-panel-id="surge">
                <div class="panel-header"><span class="dd-handle" title="Drag & Drop">â‹®â‹®</span> SURGE ALERTS âš¡</div>
                <div id="surge-container">No active surges...</div>
            </div>

            <div id="qth-panel" class="panel" data-panel-id="qth">
                <div class="panel-header"><span class="dd-handle" title="Drag & Drop">â‹®â‹®</span> QTH & CONFIG</div>
                <form id="qra-form">
                    <label for="qra_locator">Set QRA:</label>
                    <input type="text" id="qra_locator" name="qra_locator" placeholder="JN23" required>
                    <button type="submit">Update</button>
                </form>
                <p style="margin-top: 10px; font-size: 0.8em; color: #888;">
                    My Call: {{ my_call }} | SPD Threshold: {{ spd_threshold }} | Version: {{ version }}
                </p>
            </div>
            
            <div id="map-hf-panel" class="panel map-panel" data-panel-id="map-hf">
                <div class="panel-header"><span class="dd-handle" title="Drag & Drop">â‹®â‹®</span> DX MAP HF ({{ hf_bands|length }} Bands)</div>
                <div id="map-hf" class="map-area"></div>
            </div>

            <div id="map-vhf-panel" class="panel map-panel" data-panel-id="map-vhf">
                <div class="panel-header"><span class="dd-handle" title="Drag & Drop">â‹®â‹®</span> DX MAP VHF/UHF ({{ vhf_bands|length }} Bands)</div>
                <div id="map-vhf" class="map-area"></div>
            </div>
            
            <div id="chart-history-panel" class="panel" data-panel-id="chart-history">
                <div class="panel-header"><span class="dd-handle" title="Drag & Drop">â‹®â‹®</span> ACTIVITY 24H (12m/10m/6m)</div>
                <div style="height: 250px;"><canvas id="historyChart"></canvas></div>
            </div>
            
            <div id="chart-live-hf-panel" class="panel" data-panel-id="chart-live-hf">
                <div class="panel-header"><span class="dd-handle" title="Drag & Drop">â‹®â‹®</span> LIVE BAND ACTIVITY (HF)</div>
                <div style="height: 200px;"><canvas id="liveHFChart"></canvas></div>
            </div>
             <div id="chart-live-vhf-panel" class="panel" data-panel-id="chart-live-vhf">
                <div class="panel-header"><span class="dd-handle" title="Drag & Drop">â‹®â‹®</span> LIVE BAND ACTIVITY (VHF)</div>
                <div style="height: 200px;"><canvas id="liveVHFChart"></canvas></div>
            </div>

        </div>
    </div>


    <script>
        // --- VARIABLES GLOBALES (DU BACKEND) ---
        const MY_CALL = '{{ my_call }}';
        const SPD_THRESHOLD = {{ spd_threshold }};
        const HF_BANDS = JSON.parse('{{ hf_bands | tojson }}');
        const VHF_BANDS = JSON.parse('{{ vhf_bands | tojson }}');
        const BAND_COLORS = JSON.parse('{{ band_colors | tojson }}');
        const DEFAULT_QRA = '{{ user_qra }}'; 

        // --- Ã‰TATS GLOBALES (CLIENT) ---
        let userLatLng = [43.10, 5.88]; 
        let mapHF, mapVHF;
        let userMarkerHF, userMarkerVHF;
        let markersHF = new L.LayerGroup();
        let markersVHF = new L.LayerGroup();
        let watchlist = new Set();
        let historyChart, liveHFChart, liveVHFChart;


        // --- UTILITAIRES ---
        function qraToLatLng(qra) {
            try {
                qra = qra.toUpperCase().trim();
                if (qra.length < 4) return [0, 0];
                
                let lon = -180 + (qra.charCodeAt(0) - 65) * 20 + (parseInt(qra[2]) * 2) + 1;
                let lat = -90 + (qra.charCodeAt(1) - 65) * 10 + (parseInt(qra[3]) * 1) + 0.5;
                
                if (qra.length >= 6) {
                    lon += (qra.charCodeAt(4) - 65) * (2/24) + (1/24);
                    lat += (qra.charCodeAt(5) - 65) * (1/24) + (1/48);
                }
                
                return [lat, lon];
            } catch (e) {
                console.error("Invalid QRA format:", qra, e);
                return [0, 0]; 
            }
        }
        
        function updateTimeDisplay() {
            const now = new Date();
            const utcTime = now.toUTCString().split(' ')[4];
            const localTime = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            document.getElementById('utc-time').textContent = utcTime;
            document.getElementById('local-time').textContent = localTime;
        }

        function getColorByScore(score) {
            if (score >= 90) return '#FF0000'; 
            if (score >= SPD_THRESHOLD) return '#FF8C00'; 
            if (score >= 50) return '#FFD700'; 
            return '#00BFFF'; 
        }
        
        function isWanted(call) {
            return watchlist.has(call.toUpperCase());
        }

        // --- WATCHLIST ---
        async function loadWatchlist() {
            try {
                const response = await fetch('/watchlist.json');
                const data = await response.json();
                watchlist = new Set(data);
                displayWatchlist();
            } catch(e) {
                console.error("Failed to load watchlist:", e);
                document.getElementById('watchlist-body').innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--alert);">Watchlist Load Error</td></tr>';
            }
        }
        
        function displayWatchlist() {
             const body = document.getElementById('watchlist-body');
             body.innerHTML = '';
             if (watchlist.size === 0) {
                 body.innerHTML = '<tr><td colspan="4" style="text-align: center;">Watchlist is empty.</td></tr>';
                 return;
             }
             
             watchlist.forEach(call => {
                 const row = body.insertRow();
                 row.innerHTML = `
                    <td class="call"><a href="https://qrz.com/db/${call}" target="_blank" style="color: inherit;">${call}</a></td>
                    <td>-</td> 
                    <td>-</td> 
                    <td><button onclick="removeFromWatchlist('${call}')" style="color: var(--alert); border: none; background: none; cursor: pointer;">[X]</button></td>
                 `;
             });
        }
        
        async function removeFromWatchlist(call) {
            try {
                const response = await fetch('/watchlist.json', {
                    method: 'DELETE',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ call: call })
                });
                if (response.ok) {
                    watchlist.delete(call.toUpperCase());
                    displayWatchlist();
                }
            } catch (e) {
                console.error("Failed to remove from watchlist:", e);
            }
        }
        
        async function addToWatchlist(call) {
             try {
                const response = await fetch('/watchlist.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ call: call })
                });
                if (response.ok) {
                    watchlist.add(call.toUpperCase());
                    await updateData(); 
                }
            } catch (e) {
                console.error("Failed to add to watchlist:", e);
            }
        }

        // --- CARTOGRAPHIE (LEAFLET) ---
        function initMap(mapId) {
            const map = L.map(mapId, {
                worldCopyJump: true,
                center: userLatLng, 
                zoom: 3,
                layers: [
                    // FOND DE CARTE SOMBRE
                    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                        subdomains: 'abcd',
                        maxZoom: 19
                    })
                ]
            });
            map.attributionControl.setPrefix(false);
            return map;
        }

        function addUserMarker(map, lat, lon) {
            const marker = L.marker([lat, lon], {
                icon: L.divIcon({
                    className: 'user-marker',
                    html: `<div style="color:var(--accent); font-weight:bold; font-size:1.2em; text-shadow: 0 0 4px #000;">${MY_CALL}</div>`,
                    iconSize: [50, 20],
                    iconAnchor: [25, 10]
                })
            }).addTo(map);
            return marker;
        }

        function updateMaps(spots) {
            markersHF.clearLayers();
            markersVHF.clearLayers();

            spots.forEach(spot => {
                if (spot.lat && spot.lon) {
                    const bandColor = spot.color || '#ccc';
                    
                    // Marker simple (point) sans callsign
                    const markerIcon = L.divIcon({
                        className: 'dx-marker-point',
                        html: `<div style="width: 10px; height: 10px; background-color: ${bandColor}; border-radius: 50%; border: 2px solid #fff; box-shadow: 0 0 5px ${bandColor};"></div>`,
                        iconSize: [14, 14],
                        iconAnchor: [7, 7]
                    });
                    
                    const marker = L.marker([spot.lat, spot.lon], { icon: markerIcon });
                    
                    // Infobulle avec Call, Freq, Mode
                    marker.bindPopup(`
                        <b>${spot.dx_call}</b><br>
                        Freq: ${spot.freq} (${spot.band})<br>
                        Mode: ${spot.mode}<br>
                        SPD: ${spot.score} | Dist: ${spot.distance_km.toFixed(0)} km
                    `);
                    
                    if (spot.type === 'HF') {
                        markersHF.addLayer(marker);
                    } else if (spot.type === 'VHF') {
                        markersVHF.addLayer(marker);
                    }
                }
            });

            if (!markersHF.getLayers().length) { mapHF.setView(userLatLng, 3); }
            if (!markersVHF.getLayers().length) { mapVHF.setView(userLatLng, 3); }
            
            markersHF.addTo(mapHF);
            markersVHF.addTo(mapVHF);
        }

        // --- GRAPHIQUES (CHARTS.JS) ---
        function initCharts() {
            // Options de base pour tous les Bar Charts
            const barOptions = {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                plugins: { 
                    legend: { 
                        display: false, 
                        labels: { color: 'var(--text-main)' } 
                    } 
                },
                scales: {
                    x: { 
                        ticks: { 
                            color: 'var(--text-main)',
                            autoSkip: false, 
                            maxRotation: 45,
                            minRotation: 45
                        }, 
                        grid: { color: '#333' },
                        title: { display: true, text: 'Bande / Heure UTC', color: 'var(--text-main)' } 
                    },
                    y: { 
                        beginAtZero: true, 
                        ticks: { color: 'var(--text-main)' }, 
                        grid: { color: '#333' },
                        title: { display: true, text: 'Spots', color: 'var(--text-main)' } 
                    }
                }
            };
            
            // 1. History Chart (24H) - Bar Chart
            const historyCtx = document.getElementById('historyChart').getContext('2d');
            historyChart = new Chart(historyCtx, {
                type: 'bar', 
                data: { labels: [], datasets: [] },
                options: barOptions
            });

            // 2. Live HF Chart (Bar Chart)
            const liveHFCtx = document.getElementById('liveHFChart').getContext('2d');
            liveHFChart = new Chart(liveHFCtx, {
                 type: 'bar', 
                 data: { labels: [], datasets: [] },
                 options: JSON.parse(JSON.stringify(barOptions)) 
            });

            // 3. Live VHF Chart (Bar Chart)
            const liveVHFCtx = document.getElementById('liveVHFChart').getContext('2d');
            liveVHFChart = new Chart(liveVHFCtx, {
                 type: 'bar',
                 data: { labels: [], datasets: [] },
                 options: JSON.parse(JSON.stringify(barOptions))
            });
        }
        
        function updateHistoryChart(data) {
            historyChart.data.labels = data.labels;
            historyChart.data.datasets = [];
            
            const bands = Object.keys(data.data);
            bands.forEach(band => {
                historyChart.data.datasets.push({
                    label: band,
                    data: data.data[band],
                    backgroundColor: BAND_COLORS[band] ? BAND_COLORS[band] + '80' : '#ccc80', 
                    borderColor: BAND_COLORS[band] || '#ccc',
                    borderWidth: 1
                });
            });
            historyChart.options.scales.x.title.text = 'Heure UTC';
            historyChart.options.scales.y.title.text = 'Spots/30 min';
            historyChart.update();
        }
        
        function updateLiveBandsChart(chart, chartData) {
            chart.data.labels = chartData.labels;
            chart.data.datasets = [{
                label: 'Spots Actifs',
                data: chartData.data,
                backgroundColor: chartData.colors.map(c => c + 'AA'), 
                borderColor: chartData.colors,
                borderWidth: 1
            }];
            chart.options.scales.x.title.text = 'Bande';
            chart.options.scales.y.title.text = 'Spots Actifs';
            chart.update();
        }

        // --- MISE A JOUR DES DONNÃ‰ES (WORKERS PYTHON) ---
        async function updateData() {
            console.log("Fetching new data...");

            await updateSpots('hf');
            await updateSpots('vhf');
            
            try {
                const wantedResponse = await fetch('/wanted.json');
                const wantedData = await wantedResponse.json();
                displayRanking('ranking-hf', wantedData.hf);
                displayRanking('ranking-vhf', wantedData.vhf);
            } catch(e) { console.error("Failed to fetch ranking:", e); }

            try {
                const surgeResponse = await fetch('/surge.json');
                const surgeData = await surgeResponse.json();
                displaySurges(surgeData.surges);
            } catch(e) { console.error("Failed to fetch surges:", e); }
            
            try {
                const rssResponse = await fetch('/rss.json');
                const rssData = await rssResponse.json();
                document.getElementById('ticker-content').textContent = rssData.ticker;
            } catch(e) { 
                console.error("Failed to fetch RSS/Ticker:", e); 
                document.getElementById('ticker-content').textContent = "ERROR: Ticker data retrieval failed.";
            }

            try {
                const historyResponse = await fetch('/history.json');
                const historyData = await historyResponse.json();
                updateHistoryChart(historyData);
            } catch (e) { console.error("Failed to fetch history data:", e); }
            
            try {
                const liveBandsResponse = await fetch('/live_bands.json');
                const liveBandsData = await liveBandsResponse.json();
                updateLiveBandsChart(liveHFChart, liveBandsData.hf);
                updateLiveBandsChart(liveVHFChart, liveBandsData.vhf);
            } catch (e) { console.error("Failed to fetch live bands data:", e); }
            
            await loadWatchlist();
        }

        async function updateSpots(type) {
            const bodyId = `spots-body-${type}`;
            const filterBand = document.getElementById(`${type}-band-filter`).value;
            const filterMode = document.getElementById(`${type}-mode-filter`).value;
            
            let url = `/spots.json?band=${filterBand}&mode=${filterMode}`;
            
            try {
                const response = await fetch(url);
                const spots = await response.json();
                const tbody = document.getElementById(bodyId);
                tbody.innerHTML = ''; 
                
                if (spots.length === 0) {
                    tbody.innerHTML = `<tr><td colspan="7" style="text-align: center;">No ${type.toUpperCase()} spots received.</td></tr>`;
                } else {
                    spots.forEach(spot => {
                        if (spot.type.toLowerCase() === type) {
                            const row = tbody.insertRow();
                            const isWantedCall = isWanted(spot.dx_call);
                            // Utilise la classe pour forcer le gras blanc si ce n'est pas dans la Watchlist
                            const callsignClass = isWantedCall ? 'wl-table call' : 'spot-call-white-bold'; 
                            
                            row.innerHTML = `
                                <td>${spot.time}</td>
                                <td>${spot.freq}</td>
                                <td class="${callsignClass}">
                                    <a href="https://qrz.com/db/${spot.dx_call}" target="_blank" title="Look up on QRZ.com">
                                        ${spot.dx_call}
                                    </a>
                                </td>
                                <td><span class="band-tag" style="background-color: ${spot.color};">${spot.band}</span></td>
                                <td>${spot.mode}</td>
                                <td class="${(spot.score >= SPD_THRESHOLD) ? 'high-spd' : ''}">${spot.score}</td>
                                <td>${spot.distance_km.toFixed(0)}</td> `;
                            row.querySelector('td:nth-child(3)').onclick = () => {
                                if (!isWantedCall) {
                                     addToWatchlist(spot.dx_call);
                                }
                            };
                        }
                    });
                }
                
                if (type === 'hf') {
                    const allSpotsResponse = await fetch('/spots.json');
                    const allSpots = await allSpotsResponse.json();
                    updateMaps(allSpots); 
                }

            } catch(e) {
                console.error(`Failed to fetch ${type} spots:`, e);
                document.getElementById(bodyId).innerHTML = `<tr><td colspan="7" style="text-align: center; color: var(--alert);">Connection Error.</td></tr>`;
            }
        }
        
        function displayRanking(ulId, ranks) {
            const ul = document.getElementById(ulId);
            ul.innerHTML = '';
            
            if (ranks.length === 0) {
                ul.innerHTML = '<li>No ranking data.</li>';
                return;
            }
            
            ranks.forEach(spot => {
                const li = document.createElement('li');
                li.className = 'ranking-item';
                li.innerHTML = `
                    <span class="ranking-call">${spot.dx_call} (${spot.band})</span>
                    <span class="ranking-score">${spot.score} SPD</span>
                `;
                ul.appendChild(li);
            });
        }
        
        function displaySurges(bands) {
            const container = document.getElementById('surge-container');
            const panel = document.getElementById('surge-panel');
            container.innerHTML = '';
            
            if (bands.length === 0) {
                container.textContent = 'No active surges...';
                panel.classList.remove('active-surge'); 
                return;
            }
            
            panel.classList.add('active-surge'); 
            
            bands.forEach(band => {
                const span = document.createElement('span');
                span.className = 'surge-band';
                span.textContent = `!! ${band.toUpperCase()} SURGE !!`;
                container.appendChild(span);
            });
        }


        // --- DRAG & DROP / PERSISTANCE ---
        function savePanelOrder(columnId) {
            const col = document.getElementById(columnId);
            if (!col) return;
            const panelIds = Array.from(col.children).map(panel => panel.getAttribute('data-panel-id')).filter(id => id);
            localStorage.setItem(`panel_order_${columnId}`, JSON.stringify(panelIds));
        }

        function loadPanelOrder(columnId) {
            const savedOrder = localStorage.getItem(`panel_order_${columnId}`);
            if (savedOrder) {
                const panelIds = JSON.parse(savedOrder);
                const col = document.getElementById(columnId);
                const panels = {};
                Array.from(col.children).forEach(panel => {
                    const id = panel.getAttribute('data-panel-id');
                    if (id) panels[id] = panel;
                });

                panelIds.forEach(id => {
                    if (panels[id]) col.appendChild(panels[id]);
                });
            }
        }

        function initDragAndDrop() {
            ['col1', 'col2'].forEach(columnId => {
                const colElement = document.getElementById(columnId);
                loadPanelOrder(columnId); 
                
                Sortable.create(colElement, {
                    group: 'panels',
                    animation: 150,
                    handle: '.dd-handle', 
                    onEnd: function (evt) {
                        savePanelOrder(evt.from.id);
                        if (evt.from.id !== evt.to.id) {
                            savePanelOrder(evt.to.id);
                        }
                    }
                });
            });
        }
        
        // --- THÃˆME ---
        function toggleTheme() {
            const themes = ['softtech', 'dark'];
            const currentTheme = document.body.getAttribute('data-theme') || 'softtech';
            const currentIndex = themes.indexOf(currentTheme);
            const nextIndex = (currentIndex + 1) % themes.length;
            const newTheme = themes[nextIndex];
            
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            initThemeDisplay();
            
            // Mise Ã  jour des couleurs des axes des graphiques
            if (historyChart) { 
                 const color = newTheme === 'dark' ? '#f0f0f0' : '#a0a0a0';
                 historyChart.options.scales.x.ticks.color = color;
                 historyChart.options.scales.x.title.color = color;
                 historyChart.options.scales.y.ticks.color = color;
                 historyChart.options.scales.y.title.color = color;
                 historyChart.update(); 
            }
            if (liveHFChart) { liveHFChart.update(); }
            if (liveVHFChart) { liveVHFChart.update(); }
        }

        function initThemeDisplay() {
            const savedTheme = localStorage.getItem('theme') || 'softtech';
            document.body.setAttribute('data-theme', savedTheme);
            
            let displayName;
            switch(savedTheme) {
                case 'dark': displayName = 'Dark'; break;
                default: displayName = 'SoftTech';
            }
            document.getElementById('display-mode').textContent = displayName;
        }
        
        // --- FILTRES ---
        function populateFilterOptions() {
            const hfBandSelect = document.getElementById('hf-band-filter');
            const vhfBandSelect = document.getElementById('vhf-band-filter');
            
            HF_BANDS.forEach(band => {
                const opt = document.createElement('option');
                opt.value = band; opt.textContent = band;
                hfBandSelect.appendChild(opt);
            });
            VHF_BANDS.forEach(band => {
                const opt = document.createElement('option');
                opt.value = band; opt.textContent = band;
                vhfBandSelect.appendChild(opt);
            });

            hfBandSelect.addEventListener('change', () => updateSpots('hf'));
            document.getElementById('hf-mode-filter').addEventListener('change', () => updateSpots('hf'));
            
            vhfBandSelect.addEventListener('change', () => updateSpots('vhf'));
            document.getElementById('vhf-mode-filter').addEventListener('change', () => updateSpots('vhf'));
        }


        // --- INITIALISATION SÃ‰CURISÃ‰E (POINT DE PIVOT) ---
        async function initApp() {
             console.log("Starting client-side initialization...");
             
             try {
                 const locResponse = await fetch('/user_location.json');
                 const locData = await locResponse.json();
                 userLatLng = [locData.lat, locData.lon];
                 document.getElementById('qra-display').textContent = locData.qra;
             } catch (e) {
                 console.error("CRITICAL: Failed to load user location. Using default QRA:", e);
                 userLatLng = qraToLatLng(DEFAULT_QRA);
             }
             
             try {
                 await loadWatchlist();
                 populateFilterOptions();
             } catch (e) {
                  console.error("CRITICAL: Failed to load and display Watchlist/Filters.", e);
             }
             
             try {
                 mapHF = initMap('map-hf');
                 mapVHF = initMap('map-vhf');
                 userMarkerHF = addUserMarker(mapHF, userLatLng[0], userLatLng[1]);
                 userMarkerVHF = addUserMarker(mapVHF, userLatLng[0], userLatLng[1]);
                 mapHF.invalidateSize(); 
                 mapVHF.invalidateSize(); 
             } catch (e) {
                 console.error("CRITICAL: Failed to initialize Maps/Markers. Check Leaflet scripts.", e);
             }
     
             try {
                  initCharts(); 
             } catch (e) {
                 console.error("CRITICAL: Failed to initialize Charts. Check Chart.js script.", e);
             }
            
             try {
                 initDragAndDrop(); 
             } catch (e) {
                 console.error("Failed to initialize Drag and Drop. Check Sortable.js script.", e);
             }
     
             initThemeDisplay(); 
             
             setInterval(updateTimeDisplay, 1000); 
             
             try {
                 await updateData(); 
             } catch (e) {
                 console.error("CRITICAL: Initial updateData() failed. Spots/Ticker may not show initially.", e);
             }
     
             setInterval(updateData, 30000); 
             
             // Listener pour la mise Ã  jour du QRA
             document.getElementById('qra-form').addEventListener('submit', async function(event) {
                 event.preventDefault();
                 const formData = new FormData(event.target);
                 try {
                     const response = await fetch('/update_qra', {
                         method: 'POST',
                         body: formData
                     });
                     if (response.ok) {
                        const locResponse = await fetch('/user_location.json');
                        const locData = await locResponse.json();
                        userLatLng = [locData.lat, locData.lon];
                        document.getElementById('qra-display').textContent = locData.qra;
                        userMarkerHF.setLatLng(userLatLng);
                        userMarkerVHF.setLatLng(userLatLng);
                        mapHF.setView(userLatLng, mapHF.getZoom());
                        mapVHF.setView(userLatLng, mapVHF.getZoom());
                        await updateData(); 
                        alert(`QTH updated to ${locData.qra}`);
                     } else {
                        alert('QTH update failed. Please check the locator format.');
                     }
                 } catch (e) {
                     console.error("Error submitting QRA form:", e);
                     alert('Network error while updating QRA.');
                 }
             });
             
             // Listener pour l'ajout Ã  la Watchlist
             document.getElementById('add-wl-form').addEventListener('submit', async function(event) {
                 event.preventDefault();
                 const callsignInput = document.getElementById('wl_callsign');
                 const callsign = callsignInput.value.trim().toUpperCase();
                 if (callsign) {
                     await addToWatchlist(callsign);
                     callsignInput.value = ''; 
                 }
             });
         }


        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>